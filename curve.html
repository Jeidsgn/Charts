<!DOCTYPE html>
<html>
<head>
  <title>Gráfica de Curva Suavizada con D3.js</title>
  <meta charset="utf-8">
  <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <svg id="chart" width="600" height="300" style="padding: 40px;"></svg>

  <script>
    // Carga el archivo CSV
    d3.csv("data.csv").then((data) => {
      // Obtener las fechas de registro y ordenarlas
      const dates = data.map((d) => new Date(d.Registro));
      dates.sort((a, b) => a - b);

      // Limitar la cantidad de puntos a mostrar
      const maxPoints = 30;
      const step = Math.floor(dates.length / maxPoints);
      const sampledDates = dates.filter((d, i) => i % step === 0);

      // Crear la gráfica de curva suavizada
      const width = 600;
      const height = 300;
      const margin = { top: 30, right: 30, bottom: 0, left: 30 };
      const svg = d3.select("#chart");

      // Escalas
      const xScale = d3.scaleTime().domain(d3.extent(sampledDates)).range([margin.left, width - margin.right]);
      const yScale = d3.scaleLinear().domain([0, sampledDates.length]).range([height - margin.bottom, margin.top]);

      // Función para crear el degradado lineal
      const defs = svg.append("defs");
      const linearGradient = defs
        .append("linearGradient")
        .attr("id", "linear-gradient")
        .attr("gradientUnits", "userSpaceOnUse")
        .attr("x1", 0)
        .attr("y1", yScale(0))
        .attr("x2", 0)
        .attr("y2", yScale(sampledDates.length));

      linearGradient
        .append("stop")
        .attr("offset", "0%")
        .attr("stop-color", "#EF94AC");
      linearGradient
        .append("stop")
        .attr("offset", "100%")
        .attr("stop-color", "#73D0EE");

      // Aplicar filtro para suavizar la curva
      const curveData = d3.curveCardinal.tension(0.5)(sampledDates.map((d, i) => [xScale(d), yScale(i)]));

      // Crear la curva suavizada de usuarios registrados
      const area = d3
        .area()
        .x((d) => d[0])
        .y0(yScale(0))
        .y1((d) => d[1]);

      svg
        .append("path")
        .datum(curveData)
        .attr("fill", "url(#linear-gradient)") // Usar el degradado lineal como relleno
        .attr("d", area);

      // Elemento rect para mantener la línea del hover continua
      const hoverRect = svg
        .append("rect")
        .attr("x", margin.left)
        .attr("y", margin.top)
        .attr("width", width - margin.left - margin.right)
        .attr("height", height - margin.top - margin.bottom)
        .attr("fill", "none")
        .attr("pointer-events", "all"); // Permitir eventos del mouse en el rectángulo

      // Línea vertical para mostrar la información al hacer hover
      const hoverLine = svg
        .append("line")
        .attr("stroke", "#2c2c2c")
        .attr("stroke-width", "1px")
        .style("opacity", 0); // Inicialmente la línea estará oculta

      // Grupo para el texto de la fecha y cantidad de usuarios
      const infoGroup = svg.append("g").style("opacity", 0); // Inicialmente el grupo estará oculto

      // Texto para la fecha
      infoGroup
        .append("text")
        .attr("text-anchor", "middle")
        .attr("fill", "#2c2c2c")
        .attr("font-size", "12px")
        .attr("y", yScale(sampledDates.length) - 10);

      // Texto para la cantidad de usuarios
      infoGroup
        .append("text")
        .attr("text-anchor", "middle")
        .attr("fill", "#2c2c2c")
        .attr("font-size", "12px")
        .attr("y", yScale(sampledDates.length) + 10);

      // Función para mostrar la línea vertical y el texto al hacer hover
      const handleMousemove = (event) => {
        const mouseX = d3.pointer(event, hoverRect.node())[0]; // Obtener la posición X del mouse en relación con el rectángulo
        const date = xScale.invert(mouseX);

        // Buscar el índice más cercano en el arreglo de fechas
        const bisectDate = d3.bisector((d) => d).left;
        const index = bisectDate(dates, date, 1);
        const usersCount = index;

        // Mostrar la línea vertical en el punto del hover
        hoverLine
          .attr("x1", mouseX + margin.left)
          .attr("x2", mouseX + margin.left)
          .attr("y1", yScale(0))
          .attr("y2", yScale(sampledDates.length))
          .style("opacity", 1);

        // Mostrar el texto de la fecha y cantidad de usuarios
        infoGroup
          .attr("transform", `translate(${mouseX + margin.left},${yScale(sampledDates.length)})`)
          .style("opacity", 1);

        infoGroup.select("text:nth-child(1)").text(d3.timeFormat("%Y-%m-%d")(date));
        infoGroup.select("text:nth-child(2)").text(`Usuarios: ${usersCount}`);
      };

      // Función para ocultar la línea vertical y el texto al dejar de hacer hover
      const handleMouseout = () => {
        hoverLine.style("opacity", 0);
        infoGroup.style("opacity", 0);
      };

      // Añadir los eventos de hover al rectángulo
      hoverRect.on("mousemove", handleMousemove).on("mouseout", handleMouseout);

      // Eje x (sin ticks y números)
      const xAxis = d3.axisBottom(xScale).tickSize(0).tickFormat("").tickPadding(10);
      svg
        .append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(xAxis);

      // Etiqueta para el eje y de la cantidad de usuarios registrados
      svg
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", margin.left - 10)
        .attr("x", 0 - height / 2)
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .style("font-family", "Montserrat, sans-serif") // Agregar la tipografía Montserrat
        .text("Cantidad de usuarios registrados");

    })
    .catch((error) => console.error("Error al cargar el archivo CSV:", error));
  </script>
</body>
</html>
