<!DOCTYPE html>
<html>
<head>
  <title>Gráfica de Edades con D3.js</title>
  <meta charset="utf-8">
  <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <svg id="chart" width="600" height="400" style="padding: 40px;"></svg>

  <script>
    // Carga el archivo CSV
    d3.csv("data.csv").then((data) => {
      // Obtener los grupos de edad y sus colores
      const ageGroups = [
        { group: "-17", color: "#FF7EA4" },
        { group: "18-24", color: "#3E73B9" },
        { group: "25-34", color: "#9040c8" },
        { group: "35-44", color: "#4FABB2" },
        { group: "+44", color: "#FF7EA4" },
      ];

      // Calcular el conteo de usuarios para cada grupo de edad
      const ageCounts = {};
      data.forEach((d) => {
        const birthYear = new Date(d.Nacimiento).getFullYear();
        const age = new Date().getFullYear() - birthYear;
        const group = ageGroups.find((g) => g.group === getAgeGroup(age));
        ageCounts[group.group] = (ageCounts[group.group] || 0) + 1;
      });

      // Función para obtener el grupo de edad según la edad
      function getAgeGroup(age) {
        if (age <= 17) return "-17";
        if (age >= 18 && age <= 24) return "18-24";
        if (age >= 25 && age <= 34) return "25-34";
        if (age >= 35 && age <= 44) return "35-44";
        return "+44";
      }

      // Convertir el objeto de conteo en un arreglo de objetos
      const ageData = ageGroups.map((group) => ({
        group: group.group,
        count: ageCounts[group.group] || 0,
        percentage: ((ageCounts[group.group] || 0) / data.length) * 100,
      }));

      // Crear la gráfica de barras apiladas
      const width = 600;
      const height = 400;
      const margin = { top: 30, right: 30, bottom: 70, left: 100 };
      const svg = d3.select("#chart");

      // Escalas
      const xScale = d3.scaleLinear().domain([0, d3.max(ageData, (d) => d.count)]).range([margin.left, width - margin.right]);
      const yScale = d3.scaleBand().domain(ageGroups.map((group) => group.group)).range([height - margin.bottom, margin.top]).padding(0.2);

      // Crear las barras apiladas
      const bars = svg
        .selectAll(".bar")
        .data(ageData)
        .enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", margin.left)
        .attr("y", (d) => yScale(d.group))
        .attr("width", (d) => xScale(d.count) - margin.left)
        .attr("height", yScale.bandwidth())
        .attr("fill", (d) => d.color)
        .on("mouseover", handleMouseOver)
        .on("mouseout", handleMouseOut);

      // Agregar etiquetas de edad dentro de cada trozo
      svg
        .selectAll(".label")
        .data(ageData)
        .enter()
        .append("text")
        .attr("class", "label")
        .attr("x", (d) => xScale(d.count) + 10)
        .attr("y", (d) => yScale(d.group) + yScale.bandwidth() / 2)
        .attr("dy", "0.35em")
        .style("font-size", "12px")
        .text((d) => d.group);

      // Función para manejar el evento mouseover
      function handleMouseOver(d) {
        const tooltip = svg.append("g").attr("id", "tooltip");

        tooltip
          .append("rect")
          .attr("x", xScale(d.count) + 10)
          .attr("y", yScale(d.group) - 18)
          .attr("width", 60)
          .attr("height", 18)
          .attr("fill", "#f0f0f0")
          .attr("stroke", "black");

        tooltip
          .append("text")
          .attr("x", xScale(d.count) + 40)
          .attr("y", yScale(d.group) - 6)
          .attr("text-anchor", "middle")
          .style("font-size", "12px")
          .text(`${d.percentage.toFixed(2)}%`);
      }

      // Función para manejar el evento mouseout
      function handleMouseOut(d) {
        svg.select("#tooltip").remove();
      }
    })
    .catch((error) => console.error("Error al cargar el archivo CSV:", error));
  </script>
</body>
</html>
