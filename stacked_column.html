<!DOCTYPE html>
<html>
<head>
  <title>Gráfica de Barras Apiladas con D3.js</title>
  <meta charset="utf-8">
  <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <svg id="chart" width="100%" height="80" style="padding: 40px;"></svg>

  <script>
    // Carga el archivo CSV
    d3.csv("data.csv").then((data) => {
      // Obtener la cantidad de usuarios en cada grupo de edad
      const ageGroups = [
        { group: "-17", color: "#FF7EA4" },
        { group: "18-24", color: "#3E73B9" },
        { group: "25-34", color: "#9040c8" },
        { group: "35-44", color: "#4FABB2" },
        { group: "+44", color: "#FF7EA4" },
      ];

      const ageData = ageGroups.map((ageGroup) => ({
        group: ageGroup.group,
        count: data.filter((d) => getAgeGroup(d.Nacimiento) === ageGroup.group).length,
        color: ageGroup.color,
      }));

      // Función para obtener el grupo de edad según la fecha de nacimiento
      function getAgeGroup(dateString) {
        const birthDate = new Date(dateString);
        const today = new Date();
        const age = today.getFullYear() - birthDate.getFullYear();
        return age <= 17 ? "-17" : age <= 24 ? "18-24" : age <= 34 ? "25-34" : age <= 44 ? "35-44" : "+44";
      }

      // Crear la gráfica de barras apiladas
      const width = "100%";
      const height = 80;
      const svg = d3.select("#chart");

      const xScale = d3.scaleLinear().domain([0, 100]).range([0, width]);

      const bars = svg.selectAll(".bar").data(ageData).enter().append("g").attr("class", "bar");

      bars
        .append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", (d) => xScale(d.count))
        .attr("height", height)
        .attr("fill", (d) => d.color);

      bars
        .append("text")
        .attr("x", (d) => (xScale(d.count) > 30 ? 5 : xScale(d.count) + 5)) // Ajustar el espaciado del texto dentro del trozo de barra
        .attr("y", height / 2)
        .attr("dy", "0.35em")
        .style("font-family", "Montserrat, sans-serif")
        .style("font-size", (d) => (xScale(d.count) > 30 ? "14px" : "12px")) // Ajustar el tamaño de fuente para que quepa en cada trozo
        .text((d) => `${d.group} (${d.count})`);

      // Etiqueta del eje x
      svg
        .append("text")
        .attr("x", width / 2)
        .attr("y", height + 30) // Ajustar la posición vertical de la etiqueta del eje x
        .attr("text-anchor", "middle")
        .style("font-family", "Montserrat, sans-serif")
        .style("font-size", "14px")
        .text("Porcentaje de usuarios por grupo de edad");
    });
  </script>
</body>
</html>
